(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{527:function(_,v,t){"use strict";t.r(v);var o=t(4),e=Object(o.a)({},(function(){var _=this,v=_.$createElement,t=_._self._c||v;return t("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[t("h4",{attrs:{id:"tcp-三次握手"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#tcp-三次握手"}},[_._v("#")]),_._v(" TCP 三次握手")]),_._v(" "),t("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://user-gold-cdn.xitu.io/2019/6/13/16b518ccedac1b6e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"img"}}),_._v(" "),t("p",[t("strong",[_._v("第一次握手")]),_._v("：客户端发送 SYN 报文，这个报文中只有 SYN 被置位，SYN 报文不携带数据，但是占用一个序列号，下次发送序列号要加一。 初始序列号由客户端随机选择。")]),_._v(" "),t("p",[t("strong",[_._v("第二次握手")]),_._v("：服务端收到 SYN 报文后，发送 SYN + ACK 报文，SYN 用来同步服务端初始序列号，ACK 用来告知客户端之前发送的 SYN  报文已经收到，ack 字段指定了下次发送端发送的序列号，这里等于 客户端的 ISN + 1，由于 SYN 报文也需要对端确认，需要消耗一个序列号。")]),_._v(" "),t("p",[t("strong",[_._v("第三次握手")]),_._v("：客户端收到服务器 SYN 报文，发送 ACK 报文表示确认收到。因为这个 ACK 报文 不携带任何数据，也不需要确认，所以这个 ACK 不消耗任何序列号。")]),_._v(" "),t("blockquote",[t("p",[_._v("为什么 SYN 段不携带数据却要消耗一个序列号？")]),_._v(" "),t("p",[_._v("应为 SYN 需要对端确认，如果不加一，无法区分开是 SYN 的 ACK ，还是之前发送数据的 ACK。")])]),_._v(" "),t("p",[t("strong",[_._v("记住：凡是需要对端确认的，都需要消耗一个序列号，如果这个段没有收到确认，会一直重传到指定次数为止")])]),_._v(" "),t("p",[_._v("三次握手的主要作用是为了 "),t("strong",[_._v("交换彼此的初始序列号 ISN")]),_._v("，同时交换一些辅助信息：最大段大小 MSS，窗口大小 win，窗口缩放因子 ws，")]),_._v(" "),t("p",[_._v("是否选择确认等。")]),_._v(" "),t("p",[t("strong",[_._v("初始序列号")])]),_._v(" "),t("p",[_._v("初始序列号并非从 0 开始，而是通信双方各自随机生成，一般来说不会相同。生成的算法是 ISN 随时间变化，逐渐递增分配给后续 TCP 连接的 ISN。")]),_._v(" "),t("p",[_._v("一个建议的算法是设计一个假的时钟，每 4 微妙对 ISN 加一，溢出 2^32 以后回到 0，这个算法使得猜测 ISN 变得非常困难")]),_._v(" "),t("blockquote",[t("p",[_._v("初始序列号能否设置成固定值？")]),_._v(" "),t("p",[_._v("不能。")]),_._v(" "),t("p",[_._v("1.安全性 如果知道了连接的 ISN ，容易伪造 RST 包，将连接强行关掉")]),_._v(" "),t("p",[_._v("2.避免混淆 开启 S0_REUSEADDR 后允许端口重用，收到一个包后不知道是新连接的包还是旧连接的包因网络的原因姗姗来迟，容易造成数据混淆。如果采用动态增长的 ISN 就可以保证两个连接的 ISN 不会相同，不会串包。")])]),_._v(" "),t("p",[t("strong",[_._v("三次握手的状态")])]),_._v(" "),t("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://user-gold-cdn.xitu.io/2019/6/13/16b518cd1664fa5d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"img"}}),_._v(" "),t("p",[t("strong",[_._v("TCP 同时打开")])]),_._v(" "),t("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://user-gold-cdn.xitu.io/2019/6/14/16b5693e5d32aef9?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"img"}}),_._v(" "),t("p",[_._v("以其中一方为例，记为 A，另外一方记为 B")]),_._v(" "),t("ul",[t("li",[_._v("最初的状态是"),t("code",[_._v("CLOSED")])]),_._v(" "),t("li",[_._v("A 发起主动打开，发送 "),t("code",[_._v("SYN")]),_._v(" 给 B，然后进入"),t("code",[_._v("SYN-SENT")]),_._v("状态")]),_._v(" "),t("li",[_._v("A 还在等待 B 回复的 "),t("code",[_._v("ACK")]),_._v(" 的过程中，收到了 B 发过来的 "),t("code",[_._v("SYN")]),_._v("，A 没有办法，只能硬着头皮回复"),t("code",[_._v("SYN+ACK")]),_._v("，随后进入"),t("code",[_._v("SYN-RCVD")])]),_._v(" "),t("li",[_._v("A 依旧死等 B 的 ACK")]),_._v(" "),t("li",[_._v("好不容易等到了 B 的 ACK，对于 A 来说连接建立成功")])]),_._v(" "),t("blockquote",[t("p",[_._v("为什么是三次握手？两次握手？4次握手？")]),_._v(" "),t("p",[_._v("三次握手是为了确认双方具备发送和接受数据的能力。2次握手？ 无法确认客户端的接收能力。4次握手？第二次握手中 ACK + SYN 报文分成两个报文发送，可以，但是 SYN 包一般不携带数据，收到客户端的 SYN 报文后可以立即回复 ACK + SYN，故不需要")])]),_._v(" "),t("blockquote",[t("p",[_._v("第三次握手可以携带数据吗？")]),_._v(" "),t("p",[_._v("可以携带。前两次不能携带数据。")])]),_._v(" "),t("p",[_._v("::tip")]),_._v(" "),t("p",[t("strong",[_._v("TCP 自连接")])]),_._v(" "),t("p",[t("strong",[_._v("什么是 TCP 自连接？")])]),_._v(" "),t("p",[_._v("当一方主动发起连接时，操作系统会自动分配一个临时端口号给连接主动发起方。如果刚好分配的临时端口是目标端口（假设为 50000 端口），过程如下。")]),_._v(" "),t("ul",[t("li",[_._v("第一个包是发送 SYN 包给 50000 端口")]),_._v(" "),t("li",[_._v("对于发送方而已，它收到了这个 SYN 包，以为对方是想同时打开，会回复 SYN+ACK")]),_._v(" "),t("li",[_._v("回复 SYN+ACK 以后，它自己就会收到这个 SYN+ACK，以为是对方回的，对它而已握手成功，进入 ESTABLISHED 状态")])]),_._v(" "),t("p",[t("strong",[_._v("自连接危害")])]),_._v(" "),t("ul",[t("li",[_._v("自连接的进程占用了端口，导致真正监听的服务进程端口无法正常监听")]),_._v(" "),t("li",[_._v("自连接的进程虽然连接成功但是服务是不正常的，无法正常进行数据通信")])]),_._v(" "),t("p",[t("strong",[_._v("解决")])]),_._v(" "),t("ul",[t("li",[_._v("让服务器监听的端口与客户端随机分配的端口不可能相同")]),_._v(" "),t("li",[_._v("出现自连接时，主动断开连接")])]),_._v(" "),t("p",[t("strong",[_._v("总结")])]),_._v(" "),t("p",[_._v("三次握手 SYN 报文需要消耗序列号，原因是需要对端确认；ACK 报文不需要对端确认，不消耗序列")]),_._v(" "),t("p",[_._v("初始序列号不为 0 ，两端随机生成，不能设置成固定值，原因安全性和避免混淆前后连接数据。")])])}),[],!1,null,null,null);v.default=e.exports}}]);