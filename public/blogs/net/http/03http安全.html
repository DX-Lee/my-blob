<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>HTTP 安全 | ldx的博客</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="welcome to my blog">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/assets/css/0.styles.1157b0c6.css" as="style"><link rel="preload" href="/assets/js/app.8c004933.js" as="script"><link rel="preload" href="/assets/js/3.70a8af9d.js" as="script"><link rel="preload" href="/assets/js/1.1d81917b.js" as="script"><link rel="preload" href="/assets/js/30.7c12add1.js" as="script"><link rel="prefetch" href="/assets/js/10.a850a7fe.js"><link rel="prefetch" href="/assets/js/11.8fe3dac7.js"><link rel="prefetch" href="/assets/js/12.9aa6c9af.js"><link rel="prefetch" href="/assets/js/13.c850dc15.js"><link rel="prefetch" href="/assets/js/14.020bd54e.js"><link rel="prefetch" href="/assets/js/15.ae37224f.js"><link rel="prefetch" href="/assets/js/16.fcc4c76c.js"><link rel="prefetch" href="/assets/js/17.951f11bb.js"><link rel="prefetch" href="/assets/js/18.db431169.js"><link rel="prefetch" href="/assets/js/19.1d3f86a8.js"><link rel="prefetch" href="/assets/js/20.9b905235.js"><link rel="prefetch" href="/assets/js/21.d00d7c84.js"><link rel="prefetch" href="/assets/js/22.2b2915df.js"><link rel="prefetch" href="/assets/js/23.1fb4f600.js"><link rel="prefetch" href="/assets/js/24.8793607d.js"><link rel="prefetch" href="/assets/js/25.ec1d64cb.js"><link rel="prefetch" href="/assets/js/26.18b64b89.js"><link rel="prefetch" href="/assets/js/27.7ba7eb91.js"><link rel="prefetch" href="/assets/js/28.60fe6aed.js"><link rel="prefetch" href="/assets/js/29.3b5d1da1.js"><link rel="prefetch" href="/assets/js/31.96cd7fbd.js"><link rel="prefetch" href="/assets/js/32.0ea924e0.js"><link rel="prefetch" href="/assets/js/33.b4bf237d.js"><link rel="prefetch" href="/assets/js/34.db4329b1.js"><link rel="prefetch" href="/assets/js/35.01d00dab.js"><link rel="prefetch" href="/assets/js/36.0c466b4d.js"><link rel="prefetch" href="/assets/js/37.1d40db00.js"><link rel="prefetch" href="/assets/js/38.e1529e76.js"><link rel="prefetch" href="/assets/js/39.3071cb87.js"><link rel="prefetch" href="/assets/js/4.255a6205.js"><link rel="prefetch" href="/assets/js/40.2312a6a0.js"><link rel="prefetch" href="/assets/js/41.4a03e593.js"><link rel="prefetch" href="/assets/js/42.6a3920b6.js"><link rel="prefetch" href="/assets/js/43.877b55c6.js"><link rel="prefetch" href="/assets/js/44.7244fa25.js"><link rel="prefetch" href="/assets/js/45.52ebf174.js"><link rel="prefetch" href="/assets/js/46.8e472d42.js"><link rel="prefetch" href="/assets/js/47.305d08b6.js"><link rel="prefetch" href="/assets/js/48.3332322c.js"><link rel="prefetch" href="/assets/js/49.33f49b3a.js"><link rel="prefetch" href="/assets/js/5.89a79632.js"><link rel="prefetch" href="/assets/js/50.e21a4146.js"><link rel="prefetch" href="/assets/js/51.8710e989.js"><link rel="prefetch" href="/assets/js/52.c9d7c59f.js"><link rel="prefetch" href="/assets/js/53.255a5d99.js"><link rel="prefetch" href="/assets/js/54.f29e4595.js"><link rel="prefetch" href="/assets/js/55.94063b5e.js"><link rel="prefetch" href="/assets/js/56.a19c8d9c.js"><link rel="prefetch" href="/assets/js/6.8cda991c.js"><link rel="prefetch" href="/assets/js/7.dc87b874.js"><link rel="prefetch" href="/assets/js/8.bad0a13c.js"><link rel="prefetch" href="/assets/js/9.75571bbb.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1157b0c6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-2d5f533b><div data-v-2d5f533b><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-2d5f533b data-v-2d5f533b><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-2d5f533b data-v-2d5f533b><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>ldx的博客</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>ldx</span>
            
          <span data-v-64685f0e>2017 - </span>
          2021
        </a></span></div></div> <div class="hide" data-v-2d5f533b><header class="navbar" data-v-2d5f533b><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="ldx的博客" class="logo"> <span class="site-name">ldx的博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      知识汇总
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/算法/" class="nav-link"><i class="iconfont undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/categories/分类/" class="nav-link"><i class="iconfont undefined"></i>
  分类
</a></li><li class="dropdown-item"><!----> <a href="/categories/浏览器/" class="nav-link"><i class="iconfont undefined"></i>
  浏览器
</a></li><li class="dropdown-item"><!----> <a href="/categories/浏览器相关/" class="nav-link"><i class="iconfont undefined"></i>
  浏览器相关
</a></li><li class="dropdown-item"><!----> <a href="/categories/css/" class="nav-link"><i class="iconfont undefined"></i>
  css
</a></li><li class="dropdown-item"><!----> <a href="/categories/HTML/" class="nav-link"><i class="iconfont undefined"></i>
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/categories/面试相关/" class="nav-link"><i class="iconfont undefined"></i>
  面试相关
</a></li><li class="dropdown-item"><!----> <a href="/categories/JS/" class="nav-link"><i class="iconfont undefined"></i>
  JS
</a></li><li class="dropdown-item"><!----> <a href="/categories/网络协议/" class="nav-link"><i class="iconfont undefined"></i>
  网络协议
</a></li><li class="dropdown-item"><!----> <a href="/categories/随笔/" class="nav-link"><i class="iconfont undefined"></i>
  随笔
</a></li><li class="dropdown-item"><!----> <a href="/categories/杂项/" class="nav-link"><i class="iconfont undefined"></i>
  杂项
</a></li><li class="dropdown-item"><!----> <a href="/categories/性能优化/" class="nav-link"><i class="iconfont undefined"></i>
  性能优化
</a></li><li class="dropdown-item"><!----> <a href="/categories/Vue/" class="nav-link"><i class="iconfont undefined"></i>
  Vue
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签索引
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/DX-Lee" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-2d5f533b></div> <aside class="sidebar" data-v-2d5f533b><div class="personal-info-wrapper" data-v-ca798c94 data-v-2d5f533b><img src="/avatar.jpg" alt="author-avatar" class="personal-img" data-v-ca798c94> <h3 class="name" data-v-ca798c94>
    ldx
  </h3> <div class="num" data-v-ca798c94><div data-v-ca798c94><h3 data-v-ca798c94>39</h3> <h6 data-v-ca798c94>Article</h6></div> <div data-v-ca798c94><h3 data-v-ca798c94>5</h3> <h6 data-v-ca798c94>Tag</h6></div></div> <hr data-v-ca798c94></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      知识汇总
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/算法/" class="nav-link"><i class="iconfont undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/categories/分类/" class="nav-link"><i class="iconfont undefined"></i>
  分类
</a></li><li class="dropdown-item"><!----> <a href="/categories/浏览器/" class="nav-link"><i class="iconfont undefined"></i>
  浏览器
</a></li><li class="dropdown-item"><!----> <a href="/categories/浏览器相关/" class="nav-link"><i class="iconfont undefined"></i>
  浏览器相关
</a></li><li class="dropdown-item"><!----> <a href="/categories/css/" class="nav-link"><i class="iconfont undefined"></i>
  css
</a></li><li class="dropdown-item"><!----> <a href="/categories/HTML/" class="nav-link"><i class="iconfont undefined"></i>
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/categories/面试相关/" class="nav-link"><i class="iconfont undefined"></i>
  面试相关
</a></li><li class="dropdown-item"><!----> <a href="/categories/JS/" class="nav-link"><i class="iconfont undefined"></i>
  JS
</a></li><li class="dropdown-item"><!----> <a href="/categories/网络协议/" class="nav-link"><i class="iconfont undefined"></i>
  网络协议
</a></li><li class="dropdown-item"><!----> <a href="/categories/随笔/" class="nav-link"><i class="iconfont undefined"></i>
  随笔
</a></li><li class="dropdown-item"><!----> <a href="/categories/杂项/" class="nav-link"><i class="iconfont undefined"></i>
  杂项
</a></li><li class="dropdown-item"><!----> <a href="/categories/性能优化/" class="nav-link"><i class="iconfont undefined"></i>
  性能优化
</a></li><li class="dropdown-item"><!----> <a href="/categories/Vue/" class="nav-link"><i class="iconfont undefined"></i>
  Vue
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签索引
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/DX-Lee" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>HTTP协议</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blogs/net/http/01http基础.html" class="sidebar-link">HTTP 概述</a></li><li><a href="/blogs/net/http/02http进阶.html" class="sidebar-link">HTTP 进阶</a></li><li><a href="/blogs/net/http/03http安全.html" class="active sidebar-link">HTTP 安全</a></li><li><a href="/blogs/net/http/04http2和3.html" class="sidebar-link">HTTP 2</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TCP协议</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-2d5f533b><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>HTTP 安全</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>ldx</span>
            
          <span data-v-64685f0e>2017 - </span>
          2021
        </a></span></div></div> <div data-v-2d5f533b><main class="page" style="padding-right:0;"><div class="page-title" style="display:none;"><h1 class="title">HTTP 安全</h1> <div data-v-3b7f5bdf><i class="iconfont reco-account" data-v-3b7f5bdf><span data-v-3b7f5bdf>ldx</span></i> <i class="iconfont reco-date" data-v-3b7f5bdf><span data-v-3b7f5bdf>2021-01-02</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default" style="display:none;"><h4 id="https"><a href="#https" class="header-anchor">#</a> HTTPS</h4> <p>由于 HTTP 的 ”明文“、”不安全“的缺点，引入了新的 HTTPS 协议来保证通信安全。</p> <blockquote><p><strong>什么样的通信才算是“安全”的？</strong></p> <ol><li>机密性。指对数据保密</li> <li>完整性。指数据在传输过程中没有被篡改</li> <li>身份认证。指确认对方的真实身份</li> <li>不可否认。指不能否认发生的行为。</li></ol></blockquote> <p>HTTPS 规定了新的协议名 <strong>”HTTPS“</strong>，默认端口号 <strong>443</strong>，它把 HTTP 下层传输协议替换成了 <strong>SSL/TLS协议</strong>。</p> <p><strong>TLS</strong> 由记录协议、握手协议、警告协议、变更密码规范协议、扩展协议等几个子协议组成，综合使用了对称加密、非对称加密、身份认证等许多密码学前沿技术。</p> <p>浏览器和服务器在使用 TLS 建立连接时需要选择一组恰当的加密算法来实现安全通信，这些算法的组合被称为“密码套件”（cipher suite，也叫加密套件）。</p> <p>密码套件命名格式很固定，基本的形式为：”密钥交换算法 +签名算法 + 对称加密算法 + 摘要算法“</p> <blockquote><p>例如：ECDHE-RSA-AES256-GCM-SHA384</p> <p>这个密码套件表示：握手时使用 ECDHE 算法进行密钥交换，用 RSA 算法签名和身份验证，握手后的通信使用 AES256 对称算法，米密钥长度时 256，分组模式是 GCM，摘要算法用 SHA 384用于消息认证和产生随机数</p></blockquote> <h5 id="机密性"><a href="#机密性" class="header-anchor">#</a> <strong>机密性</strong></h5> <p>实现机密性常用方法就是 ”加密“。加密前的消息叫做 <strong>明文</strong>，加密的钥匙叫做 <strong>密钥</strong>，明文加密后的乱码叫做 <strong>密文</strong>，使用密钥还原明文叫做 <strong>解密</strong>，加密解密的操作过程叫做 ”<strong>加密算法</strong>”</p> <p>加密算法都是公开的，而算法使用的密钥是保密的。根据密钥的使用方式分为 <strong>对称加密</strong> 和 <strong>非对称加密</strong></p> <p>​	<strong>对称加密</strong></p> <p>​	加密和解密使用的密钥都是同一个密钥。</p> <p>​	<strong>非对称加密</strong></p> <p>​	对称加密好像实现了机密性。但是如何把密钥安全的传递给对方呢？如果密钥被截获，那么通信也就毫无机密性可言。于是出现了非对称加密。</p> <p>​	非对称加密采用了 2 个密钥，一个是 <strong>公钥</strong>，另一个是 <strong>私钥</strong>。公钥可以公开给任何人知道，而私钥必须严格保密。</p> <p>​	公钥和私钥有个特别的单向性：<strong>公钥加密的密文只能用私钥解密，私钥加密的密文只能用公钥解密</strong></p> <p>​	由于黑客不知道私钥，所以无法知道公钥加密后的密文。</p> <p><strong>非对称加密</strong> 加密虽然没有 **”密钥交换“**的问题，但由于加密过程基于复杂的数学运算，运算速度很慢，与对称加密差了好几个量级，如果仅使用非对称加密，虽然实现了机密性，但是通信的速度太慢，实用性太差。</p> <p><strong>混合加密</strong></p> <p>最好的方法是将对称加密和非对称加密结合起来，也就是 <strong>混合加密</strong>的方式。</p> <p>通信开始阶段使用非对称加密，解决密钥交换的问题。使用随机数产生对称算法使用的 <strong>”会话密钥“</strong>，再使用公钥加密，对方拿到密文后使用私钥解密得到会话密钥，这样就实现了密钥交换，后续就使用对称加密进行通信。</p> <h5 id="完整性"><a href="#完整性" class="header-anchor">#</a> <strong>完整性</strong></h5> <p><strong>混合加密</strong> 实现了通信内容机密性，但是黑客可以通过收集足够多的密文，尝试修改，重组后发给网站，应为没有完整性保证，服务器只能照单全收，这样通过服务器的响应获取下一步线索，最后还是会破解出明文。</p> <p>实现完整性主要靠 <strong>摘要算法</strong> ，也就是常说的 离散函数、哈希函数。</p> <p>有了 <strong>摘要算法</strong>，只要再原文后附上它的摘要就可以保证内容的完整性。但是摘要算法不具有机密性，所以摘要和明文需要一起被加密。</p> <p><strong>身份认证</strong></p> <p>黑客也可以伪装成你向网站发送支付转账等消息，网站没有办法确认你的身份，就会有安全问题。所以需要保证通信双方身份的真实性，现实生活中解决身份认证的手段是签名和印章，只要在纸上签名或者印章，就表示这份文件确实是本人发出的而不是其他人。而这个签名和印章必须是本人持有，独一无二的，只要用这个东西就能证明自己的身份，这个东西就是非对称加密里的 <strong>私钥</strong>。</p> <p>用 <strong>私钥</strong> 加上摘要算法就能实现 ”数字签名“，同时实现身份认证和不可否认。</p> <p><strong>数字签名</strong>的原理很简单，就是私钥加密，公钥解密。只要你和网站交换了公钥，就能使用 <strong>”签名“</strong> 和 **”验签“**来验证消息的真实性。</p> <p><strong>数字证书和 CA</strong></p> <p>前面所说因为谁都可以发布公钥，公钥的真实性怎么保证呢？也就是怎么证明这是你的或者是网站的公钥？</p> <p>加入使用类似密钥交换的方式解决公钥认证的问题，那么只会陷入死循环，必须借助一个“外力”，找一个可以信任的第三方作为信任的起点，这个第三方就是 <strong>CA（Cerificate Authority，证书认证中心）</strong>。</p> <p><strong>CA</strong> 对公钥的签名认证也是有格式的，不能简单将公钥绑定在持有者身份上就完事了，，还要包含序列号，用途，颁发者，有效时间等，把它们打包再签名，形成 <strong>数字证书</strong>。</p> <p>CA 也需要证明自己。小一点的 CA 可以让大 CA 签名认证，到链条的最后也就是 <strong>Root CA</strong>，只能自己证明自己，这就是 <strong>自签名证书</strong>，你必须相信否则整个证书信任链就走不下去了。</p> <p>操作系统和浏览器都内置了各大 CA 的根证书，上网的时候只要服务器发过来它的证书，就可以验证证书里的签名，顺着证书链（Certificate Chain）一层层地验证，直到找到根证书，就能够确定证书是可信的，从而里面的公钥也是可信的。</p> <h4 id="https-建立连接"><a href="#https-建立连接" class="header-anchor">#</a> HTTPS 建立连接</h4> <p>HTTP 协议里三次握手建立连接后，就可以发送 HTTP报文；但是 HTTPS 还需要另外一个 ”握手“ 的过程，在 TCP 上建立安全连接后在发送报文。</p> <p><strong>TLS 1.2 版本</strong></p> <ol><li><p><strong>传统RSA连接</strong></p> <p>TCP 建立连接后，首先会发送 <strong>Client Hello</strong> 消息，也就是向服务器 “打招呼”。里面有客户端的版本号，支持的密码套件，还有一个 <strong>随机数（Client Random）</strong>，用于生成后续会话密钥。</p> <p>然后服务端回应 <strong>Server Hello</strong> 消息，把版本号确认一下，然后选择一种密码套件（RSA），将服务器生成的一个 <strong>随机数（Server Random）</strong>，一并发给对方，然后服务器为了验证自己的身份，将证书也发给了客户端。</p> <p>之后是 <strong>Server Hello Done</strong> 消息，表示我的消息就这些，”打招呼“完毕。</p> <p>客户端收到证书后开始走证书链逐级验证，验证服务器身份无误之后，根据密码套件生成 <strong>pre-master</strong>，这其实也是一个随机数。客户端发送一个 <strong>Client Key Exchange</strong> 消息， 将pre-master加密后发给服务器。</p> <p>这样双方都有 3个随机数，通过这三个随机数生成主密钥。主密钥生成后握手就快结束了，客户端会发一个 <strong>Change Cipher Spec</strong>，然后再发一个 <strong>Finished</strong> 消息，把之前的数据做一个 <strong>摘要</strong>，再加密一下，让服务端做验证。意思是之后通信就用这个密钥加密了，密钥对不对服务器再测一下。</p> <p>服务器也是同样的操作发送 <strong>Change Cipher Spec</strong> ， <strong>Finished</strong> 消息，双方验证加密解密，后续就使用加密后的 HTTP 请求和响应。</p></li> <li><p><strong>ECDHE 连接</strong></p> <p>之前是传统的 RSA 握手过程，现在主流的TLS 握手过程使用的是 ECDHE 加密套件。</p> <p>与RSA大致流程相同，不同的是由于使用的 ECDHE 算法，服务器还会生成一个 <strong>Server Params</strong> ，这是 <strong>椭圆曲线的公钥</strong>，在发送证书后发送一个 <strong>Server Key Exchange</strong> 消息，里面就是Server Params，用来实现密钥交换算法，再加上自己的私钥签名认证。</p> <p>然后客户端按照密码套件的要求，也生成一个 <strong>Client Params</strong>，用 <strong>Client Key Exchange</strong> 消息发送给服务器。</p> <p>现在客户端和服务端都拿到了密钥交换算法的两个参数 <strong>Server Params</strong> 和 <strong>Client Params</strong>，通过 ECDHE 算法计算生成 <strong>pre-master</strong>，用 客户端随机数和服务端随机数加上这个 pre-master，就可以生成主密钥。</p> <p>主密钥也不是最终通信的会话密钥，还会用PRF算法扩展出更多密钥，比如客户端发送用的会话密钥，服务器发送用的会话密钥等等，避免只用一个密钥带来的安全隐患。</p> <p>与传统的RSA握手过程有两点不同：</p> <ol><li>RSA握手 <strong>Client Key Change</strong> 消息里面是 <strong>pre-master</strong>；ECDHE 握手则是 <strong>密钥交换算法的参数</strong>，pre-master由双方自己计算而来。</li> <li>ECDHE 算法可以不等服务端发送 <strong>Finshed</strong> 消息确认握手完毕，立即发送 HTTP 报文，节省了一个 消息往返时间的浪费。这个叫 <strong>&quot;TLS False Start&quot;</strong>，意思是 ”抢跑“，与 “TCP Fast Open” 有点像，都是不等连接完全建立就提前发送数据。</li></ol></li></ol> <p><strong>双向认证</strong></p> <p>上面所说的是 <strong>单向认证</strong>，只验证了服务器的身份，客户端的身份还没认证。这是因为通常单向认证之后已经建立了安全通信，可以用账号密码等确认客户端的身份。</p> <p>为了防止账号、密码被盗，有时候比如（网上银行）还会使用 U盾 给客户端颁发证书，<strong>实现双向认证</strong>。</p> <p>双向认证流程没有太多变化，只是再 <strong>Server Hello Done</strong> 之后，<strong>Client Key Exchange</strong> 之前，客户端发送 <strong>Client Certificate</strong> 消息，将自己的证书发给服务器进行验证。</p> <p><strong>TLS 1.3版本</strong></p> <p>TLS1.2 版本已经是十几年前的的老协议，再安全和性能方面已经跟不上现在的互联网了。于是有了 TLS1.3版本。</p> <p>TLS1.3版本的主要改进目标是 <strong>兼容，安全，性能</strong></p> <p><strong>兼容</strong></p> <p>1.1 1.2版本出现了很多年，许多应用软件，代理商只认识老的记录格式，更新改造困难。为了区分 1.2 和 1.3版本，要用到新的 <strong>扩展协议</strong>。通过再记录头的末尾添加一系列扩展字段来增加新的功能。</p> <p>在记录头的 <strong>Version</strong> 字段被兼容性固定的情况下，只要是 TLS 1.3协议，握手的 <strong>&quot;Hello&quot;</strong> 协议后就必须有 <strong>”support_versions&quot;</strong> 字段，他标记了TLS的版本号。</p> <p><strong>强化安全</strong></p> <p>TLS 1.2 陆续被发现了很多漏洞和加密算法的弱点，因此 TLS1.3 版本修补了这些不安全的因素。</p> <p>废除了多种算法后，TLS1.3 只保留了 AES, ChaCha20 算法，分组模式只能用 AEAD的 GCM、CCM 和 Poly1305，摘要算法只能使用 SHA256、SHA384，密钥交换算法只有 ECDHE 和 DHE，椭圆曲线也被“砍”到只剩 P-256 和 x25519 等 5 种。</p> <blockquote><p>这里还要特别说一下废除 RSA 和 DH 密钥交换算法的原因.</p> <p>假设有这么一个很有耐心的黑客，一直在长期收集混合加密系统收发的所有报文。如果加密系统使用服务器证书里的 RSA 做密钥交换，一旦私钥泄露或被破解（使用社会工程学或者巨型计算机），那么黑客就能够使用私钥解密出之前所有报文的“Pre-Master”，再算出会话密钥，破解所有密文。</p> <p>而 ECDHE 算法在每次握手时都会生成一对临时的公钥和私钥，每次通信的密钥对都是不同的，也就是“一次一密”，即使黑客花大力气破解了这一次的会话密钥，也只是这次通信被攻击，之前的历史消息不会受到影响，仍然是安全的。</p> <p>以现在主流的服务器和浏览器在握手阶段都已经不再使用 RSA，改用 ECDHE，而 TLS1.3 在协议里明确废除 RSA 和 DH 则在标准层面保证了“前向安全”</p></blockquote> <p><strong>提升性能</strong></p> <p>HTTPS 建立连接时需要再进行 TLS 握手，再 1.2版本中会多花 2 个RTT的消息往返时间，可能会导致几十甚至几百毫秒的延迟，在移动网络中延迟还会更严重。</p> <p>TLS 1.3 密码套件大幅简化后，就不必再向以前那样走复杂的流程了。TLS1.3 压缩了以前的“Hello”协商过程，删除了“Key Exchange”消息，把握手时间减少到了“1-RTT”，效率提高了一倍。</p> <p>具体的做法还是利用了扩展。客户端在“Client Hello”消息里直接用“<strong>supported_groups</strong>”带上支持的曲线，比如 P-256、x25519，用 “<strong>key_share</strong>” 带上曲线对应的客户端公钥参数，用“<strong>signature_algorithms</strong>”带上签名算法。</p> <p>服务器收到后在这些扩展里选定一个曲线和参数，再用 <strong>“key_share”</strong> 扩展返回服务器这边的公钥参数，就实现了双方的密钥交换，后面的流程就和 1.2 基本一样了</p> <h4 id="https-性能优化"><a href="#https-性能优化" class="header-anchor">#</a> HTTPS 性能优化</h4> <p>HTTPS 连接”慢“通常指的时刚开始建立连接那段时间。除了TLS 握手带来的网络耗时外，产生密钥交换的临时公私钥对（ECDHE）、验证证书、非对称加密处理 “pre-master&quot;</p> <p>那有哪些手段可以进行优化呢？</p> <p><strong>硬件优化</strong></p> <ol><li><p>更快的 CPU</p></li> <li><p>SSL加速卡：加解密时调用它的API，让专门的硬件来做非对称加密，分担 CPU 的计算压力。但是也有缺点：升级慢，支持算法有限，不能灵活制定解决方案</p></li> <li><p>SSL加速服务器：用专门的服务器集群来彻底“卸载”TLS 握手时的加密解密计算，性能自然要比单纯的“加速卡”要强大的多。</p></li></ol> <p><strong>软件优化</strong></p> <p>软件优化比较简单，就是尽量将正在使用的软件升级到最新版本，由于软件在更新版本的时候都会做性能优化、修复错误，因此优化效果最容易达到。</p> <p><strong>协议优化</strong></p> <p>尽量采用 TLS1.3 版本，它大幅简化了握手过程，相比TLS1.2 少了 1 RTT，而且更加安全。</p> <p><strong>会话复用</strong></p> <p>会话复用分两种：</p> <p>一种叫 <strong>”Session ID“</strong>：就是客户端和服务器首次连接后各自保存一个会话的 ID 号，内存里存储主密钥和其他相关的信息。当客户端再次连接时发一个 ID 过来，服务器就在内存里找，找到就直接用主密钥恢复会话状态，跳过证书验证和密钥交换，只用一个消息往返就可以建立安全通信。</p> <p>另一种叫 <strong>&quot;Session Ticket&quot;</strong>: 它有点类似 HTTP 的 Cookie，存储的责任由服务器转移到了客户端，服务器加密会话信息，用“New Session Ticket”消息发给客户端，让客户端保存。</p> <p>重连的时候，客户端使用扩展“<strong>session_ticket</strong>”发送“Ticket”而不是“Session ID”，服务器解密后验证有效期，就可以恢复会话，开始加密通信。不过“Session Ticket”方案需要使用一个固定的密钥文件（ticket_key）来加密 Ticket，为了防止密钥被破解，保证“前向安全”，密钥文件需要定期轮换，比如设置为一小时或者一天。</p> <p><strong>预共享密钥</strong></p> <p>原理和“Session Ticket”差不多，但在发送 Ticket 的同时会带上应用数据（Early Data），免去了 1.2 里的服务器确认步骤，这种方式叫“<strong>Pre-shared Key</strong>”，简称为“PSK”。</p> <p>但“PSK”也不是完美的，它为了追求效率而牺牲了一点安全性，容易受到“重放攻击”（Replay attack）的威胁。黑客可以截获“PSK”的数据，像复读机那样反复向服务器发送。</p> <p>解决的办法是只允许安全的 GET/HEAD 方法，在消息里加入时间戳、“nonce”验证，或者“一次性票证”限制重放。</p> <blockquote><p>&quot;Session ID&quot; 和 &quot;Session Ticket&quot; 这两种会话复用的方式在 TLS1.3中均已经被废除了，只能使用 PSK 实现会话复用</p></blockquote></div> <footer class="page-edit" style="display:none;"><!----> <!----></footer> <!----> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.8c004933.js" defer></script><script src="/assets/js/3.70a8af9d.js" defer></script><script src="/assets/js/1.1d81917b.js" defer></script><script src="/assets/js/30.7c12add1.js" defer></script>
  </body>
</html>
