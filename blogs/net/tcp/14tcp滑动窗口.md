---
title: TCP 滑动窗口
date: 2021-1-11
tags:
 - TCP
categories:
 - 网络协议
---

**TCP 流量控制**

TCP 会把要发送的数据放在发送缓冲区 （Send Buffer）,接收到的数据放在接收缓冲区(Receive Buffer)，应用程序会不断的读取接收缓冲区的内容进行处理。

流量控制要做的事就是当接收缓冲区满了之后，发送端应该停止发送数据。那么发送端如何知道接收端缓冲区满了呢？

为了控制发送端发送速率，接收端会告知发送端自己的接收窗口大小 (Receive Window)，也就是接收缓冲区剩余部分。

<img src="https://user-gold-cdn.xitu.io/2019/6/25/16b8f55a26a6a568?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" style="zoom:50%;" />

TCP 在返回的 ACK包里会带上自己的接收窗口大小，发送端需要根据这个值调整自己的发送策略。

**滑动窗口**

TCP 滑动窗口分为接收窗口和发送窗口。

**发送窗口和接收窗口**

如图：win = 29312 指的是 发送端窗口大小吗？

<img src="https://user-gold-cdn.xitu.io/2019/6/25/16b8f55a25d71532?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" style="zoom:50%;" />

并不是。这里的 win = 29312 指的是接收端接收窗口大小，对方收到后会将自己的发送窗口大小限制在 29312 大小以内。如果处理能力有限，导致接收窗口大小为 0，发送端应该停止发送数据。

**TCP 包状态分类**

从 TCP 的角度，数据包的状态可以分为以下几类。

<img src="https://user-gold-cdn.xitu.io/2019/3/10/16968005b1f1b27a?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" style="zoom:50%;" />

- #1 部分是已经发送且已经确认的数据包
- #2 部分是已经发送但是未收到 ACK 确认的数据包
- #3 部分是还未发送但是接收端可以接收的数据包
- #4 部分是还未发送却这部分接收端没有空间可以接收的数据包

**发送窗口和可用窗口**

发送窗口是 TCP 滑动窗口的核心概念。它指的是某一端在某一时刻能够拥有的最大未确认数据包大小（即在途数据），发送窗口是发送端允许发送的最大数据包大小，等于 #2 + #3 区域加起来的总大小

可用窗口指的是发送端还能发送的数据包大小，它等于发送窗口大小减去在途数据包大小，等于 #3 部分。

​	

**window Full 和 Zero window**

windwo Full 当发送端发送的在途数据包字节数要超过接收窗口的大小时，发送端会停止发送，等待在途数据包的确认

Zero window：当接收窗口变为0时，发送端会停止发送数据，如果接收端经过一段时间可以处理更多数据包了，当时发送端并不知情，于是发送 零窗口探测探测包，用来向接收端探测，是否能够发送数据。这个探测包实际上就是一个 ACK 包	 

window Full 和 Zero window都是控制发送速率的手段

- window Full 是站在发送端的角度，表示在途字节数等于对方接收窗口的情况，此时发送端不能再发数据给对方直到发送的数据包得到 ACK。
- zero window 是站在**接收端**角度来说的，是接收端接收窗口满，告知对方不能再发送数据给自己。