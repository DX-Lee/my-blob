---
title: 从输入URL到页面展示，这中间发生了什么？
date: 2021-2-1
tags:
 - 浏览器
categories:
 - 浏览器
---

#### 从输入URL到页面展示，这中间发生了什么？

**导航阶段**

- 首先浏览器会判断输入的是关键字还是 请求的URL

  - 如果是关键字，则地址栏会使用浏览器默认的搜索引擎，合成新的带搜索关键字的URL
  - 如果输入内容符合URL规范，则会根据规则拼成完整的URL，比如 baidu.com，会被拼成 https://www.baidu.com

  当用户输入关键字回车后，浏览器就会进入加载状态。标签页上的图标会进入加载状态，但页面显示还是之前的页面内容，需要等待提交文档阶段，页面内容才会被替换。

- 接下来就进入到URL请求阶段。

  浏览器主进程通过 IPC 通信将 URL 发送给网络进程，由网络进程发起请求。网络进程首先会查找缓存，如果没有找到缓存，直接进入网络请求流程。请求第一步需要获取请求域名的IP地址，所以需要进行DNS解析，层层解析之后得到 IP 地址，然后进行 TCP 连接，如果是 HTTPS 还要进行 TLS 连接。连接建立后，浏览器会构建请求行，请求头等信息，并把该域名下的 cookie 加到请求头中，然后向服务器发送构建好的请求信息。服务器接收到请求消息后，将响应数据发给网络进程，网络进程开始解析响应头。

  如果响应头包含重定向信息，如301，302, 则网络进程会从 Location 字段中读取重定向的地址，重新发起网络请求。

  如果返回 200，则继续处理响应数据。根据 Content-Type 的值来决定如何显示响应内容，如果是 HTML ，则继续进行导航流程，如果是下载类型，则交给下载管理器，导航结束。

  由于chrome 页面渲染时在渲染进程中的，所以需要创建一个渲染进程。但有特殊情况，如果新打开的页面和当前页面是 **同一站点**（根域名和协议一样），则新打开的页面会复用父页面的渲染进程。渲染进程准备好后还不能立刻进行文档解析，应为响应数据还在网络进程中，因此下一步是提交文档阶段。

- 提交文档阶段

  ”提交文档“ 消息是由浏览器主进程发出的，渲染进程接收到 ”提交文档“ 的消息后会和网络进程建立传输数据的管道。等到数据传输完毕之后，渲染进程会像浏览器主进程发送 “确认提交” 的消息，浏览器主进程收到确认提交的消息后会更新浏览器的界面状态，包括 地址栏URL，安全状态，前后退的历史状态，并更新 Web 页面。

  <img src="C:\Users\李东旭\AppData\Roaming\Typora\typora-user-images\image-20210201163734075.png" alt="image-20210201163734075" style="zoom: 80%;" />

  到这里导航流程结束，进入渲染流程。

**渲染阶段**

- 构建 DOM 树：将 HTML 转化成浏览器可理解的结构，DOM树。

- 样式计算：

  - 首先把CSS转换成浏览器可理解的结构，即 styleSheets。
  - 转换样式表中的属性，使其标准化
  - 计算 DOM 树中每个节点的具体样式

- 创建布局树：计算DOM树中可见节点的几何位置信息，生成布局树。

- 分层：渲染引擎为一些特定的节点生成对应的图层，方便实现一些复杂的效果，并生成一个图层树（Layer tree）

  并不是所有节点都会生成图层树，如果一个节点没有自己的图层，那么它从属于父节点的图层。

  - 1.拥有层叠上下文属性的节点会被提升为一层
  - 2.需要裁剪（clip) 的地方也会被创建图层：比如文字区域面积超过容器面积会产生裁剪，如果出现滚动条，滚动条也会被提升为单独的一层

- 图层绘制：将一个图层的绘制分成多个小的绘制指令，在把这些指令按照顺序组成一个待绘制列表。

- 栅格化（raster）操作:

  ​	绘制列表只是用来记录顺序和指令的列表，实际的绘制操作实在合成线程中完成的。

  - 绘制列表准备好之后，渲染进程的主进程会将绘制列表提交（**commit**）给合成线程。
  - 合成线程收到后会将图层分成图块，因为有些图层可能很大，而用户只能看到视口内的部分，这个时候要绘制所有的图层内容会有比较大的开销，而且也没有必要。因此合成线程会按照视口附近的图块优先生成位图，实际生成位图的操作由栅格化来执行，栅格化就是将图块转换成位图。
  - 渲染进程维护了一个栅格化的线程池，所有图块栅格化都是在线程池内执行，通常栅格化都会使用GPU加速，使用GPU加速生成位图的过程叫做快速栅格化。如果栅格化使用了GPU加速，那么还需要跨进程操作。
  - 将生成图块的指令发送给GPU进程，GPU生成位图后保存在GPU的内存中

- 合成显示：

  一旦所有图块都被光栅化，合成线程就会发送一个绘制图块的命令 **“DrawQuad”**给浏览器进程。

  浏览器进程里有一个叫 viz 的组件用来接收合成线程发送过来的 DrawQuad 命令，然后根据 DrawQuad 命令将页面内容绘制到内存中，最后将内存中的内容显示在屏幕上。

**重排、重绘和合成**

- 当元素几何属性发生变化时会进行 **重排**。**重排** 需要更新完整的渲染流水线，因此开销是最大的。

- 当元素的颜色样式等属性发送变化时会进行 **重绘**。相比重排，重绘省去了布局和分层阶段，所以执行效率要更高一点。

- 直接合成。如果不需要更新元素的几何属性和绘制属性，渲染引擎将会跳过布局和绘制，直接进入合成操作。例如 transform: 

  相比重排和重绘，合成的效率提升非常高。